name: Test

on: [push, pull_request]

jobs:
  test:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Set up JDK 21
      uses: actions/setup-java@v2
      with:
        java-version: 21
        distribution: adopt

    - name: Install sbt
      uses: sbt/setup-sbt@v1

    - name: Publish collector locally
      run: |
        git clone --branch 3.4.0 --depth 1 https://github.com/snowplow/stream-collector.git
        cd stream-collector
        echo '1.11.0' > project/build.properties # temporary fix until collector uses java 21
        sbt 'project core; set version := "3.4.0"; set scalaVersion := "2.12.20"; publishLocal'

    - name: Run sbt
      run: sbt test

    - name: Test fat jar assembly and execution
      run: |
        # Assemble fat jar
        sbt 'project micro' clean assembly
        
        # Find the generated jar file in the correct location
        JAR_FILE=$(find target/scala-2.12/assembled_jars -name "snowplow-micro-*" | head -n 1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "Error: No assembly jar found in target/scala-2.12/assembled_jars"
          exit 1
        fi
        
        echo "Found jar file: $JAR_FILE"
        
        # Start the application in background
        timeout 30s java -jar "$JAR_FILE" > app_output.log 2>&1 &
        APP_PID=$!
        
        # Wait a bit for startup
        sleep 10
        
        # Check if the expected line appears in the output
        if grep -q "started at http://\[::\]:9090/" app_output.log; then
          echo "✅ Success: Found expected startup message"
          kill $APP_PID 2>/dev/null || true
          exit 0
        else
          echo "❌ Error: Expected startup message not found"
          echo "Application output:"
          cat app_output.log
          kill $APP_PID 2>/dev/null || true
          exit 1
        fi
